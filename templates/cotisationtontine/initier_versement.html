{% extends "base.html" %}
{% block title %}Effectuer un versement{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">
    Effectuer un versement pour
    <strong>{{ member.user.nom|default:member.user.phone }}</strong>
  </h2>

  <form method="post" id="versement-form" class="needs-validation" novalidate>
    {% csrf_token %}

    <!-- Champ montant -->
    <div class="mb-3">
      <label for="montant" class="form-label">Montant Ã  verser (FCFA)</label>
      <input
        type="number"
        class="form-control"
        name="montant"
        id="montant"
        min="1"
        step="1"
        required
        placeholder="Ex: 5000"
      >
      <div class="invalid-feedback">
        Veuillez saisir un montant valide supÃ©rieur Ã  0.
      </div>
    </div>

    <!-- Champ mÃ©thode de paiement -->
    <div class="mb-3">
      <label for="methode" class="form-label">MÃ©thode de paiement</label>
      <select name="methode" id="methode" class="form-select" required>
        <option value="paydunya" selected>PayDunya</option>
        <option value="caisse">Caisse (sans frais)</option>
      </select>
      <div class="invalid-feedback">
        Veuillez sÃ©lectionner une mÃ©thode de paiement.
      </div>
    </div>

    <!-- Infos frais -->
    <div class="mb-3" id="frais-section" style="display:none;">
      <p class="mb-1">ðŸ§¾ <strong>Frais :</strong> <span id="frais">0</span> FCFA</p>
      <p class="mb-1">ðŸ’³ <strong>Total Ã  payer :</strong> <span id="total">0</span> FCFA</p>
    </div>

    <!-- Boutons -->
    <button type="submit" class="btn btn-success" id="submit-btn">ðŸ’³ Payer avec PayDunya</button>
    <a href="{% url 'cotisationtontine:group_detail' member.group.id %}" class="btn btn-secondary ms-2">Annuler</a>
  </form>
</div>

<script>
(() => {
  'use strict'
  const form = document.getElementById('versement-form');
  form.addEventListener('submit', (event) => {
    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    }
    form.classList.add('was-validated');
  }, false);
})();

document.addEventListener('DOMContentLoaded', function() {
  const montantInput = document.getElementById('montant');
  const methodeSelect = document.getElementById('methode');
  const fraisEl = document.getElementById('frais');
  const totalEl = document.getElementById('total');
  const fraisSection = document.getElementById('frais-section');
  const submitBtn = document.getElementById('submit-btn');

  function updateFrais() {
    let montant = parseFloat(montantInput.value);
    if (isNaN(montant) || montant <= 0) {
      montant = 0;
    }
    const methode = methodeSelect.value;

    if (methode === 'paydunya' && montant > 0) {
      const fraisPourcent = montant * 0.02;
      const fraisFixe = 50;
      const fraisTotal = Math.round(fraisPourcent + fraisFixe);
      const total = Math.round(montant + fraisTotal);

      fraisEl.textContent = fraisTotal.toString();
      totalEl.textContent = total.toString();
      fraisSection.style.display = 'block';
      submitBtn.textContent = 'ðŸ’³ Payer avec PayDunya';
    } else {
      fraisSection.style.display = 'none';
      submitBtn.textContent = 'âœ… Enregistrer le versement';
    }
  }

  montantInput.addEventListener('input', updateFrais);
  methodeSelect.addEventListener('change', updateFrais);
  updateFrais();
});
</script>
{% endblock %}
