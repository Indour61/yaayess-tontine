{% extends "base.html" %}
{% block title %}Effectuer un versement{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Messages Django -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="mb-0">
      Effectuer un versement pour
      <strong>{{ member.user.nom|default:member.user.phone }}</strong>
    </h2>
    <a href="{% url 'cotisationtontine:group_detail' member.group.id %}" class="btn btn-outline-secondary">
      ‚Üê Retour au groupe
    </a>
  </div>

  <p class="text-muted mb-4">
    Groupe : <strong>{{ member.group.nom }}</strong> ‚Ä¢ Montant de base : <strong>{{ member.group.montant_base|floatformat:0 }} FCFA</strong>
  </p>

  <form method="post" id="versement-form" class="needs-validation" novalidate>
    {% csrf_token %}

    <!-- M√©thode forc√©e √† PayDunya -->
    <input type="hidden" name="methode" value="paydunya" />

    <div class="row g-3">
      <!-- Montant -->
      <div class="col-12 col-md-6">
        <label for="montant" class="form-label">Montant √† verser (FCFA)</label>
        <div class="input-group">
          <span class="input-group-text">FCFA</span>
          <input
            type="number"
            class="form-control"
            name="montant"
            id="montant"
            min="1"
            step="1"
            required
            placeholder="Ex: 5000"
            inputmode="numeric"
            autocomplete="off"
          >
        </div>
        <div class="form-text">Saisissez un montant positif. Les d√©cimales seront arrondies automatiquement.</div>
        <div class="invalid-feedback">Veuillez saisir un montant valide sup√©rieur √† 0.</div>
      </div>
    </div>

    <!-- R√©cap frais -->
    <div class="card mt-3" id="frais-card" style="display:none;">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-center justify-content-between">
          <div class="me-3">
            <div class="mb-1">üßæ <strong>Frais estim√©s</strong> (2,5% + 75 FCFA) : <span id="frais" class="fw-semibold">0</span> FCFA</div>
            <div>üí≥ <strong>Total √† payer</strong> : <span id="total" class="fw-semibold">0</span> FCFA</div>
          </div>
          <div class="text-muted small">
            * Le total affich√© est calcul√© √† titre indicatif avant redirection.
          </div>
        </div>
      </div>
    </div>

    <!-- Boutons -->
    <div class="mt-3 d-flex align-items-center">
      <button type="submit" class="btn btn-success" id="submit-btn">
        üí≥ Payer avec PayDunya
      </button>
      <button type="button" class="btn btn-link d-none" id="loading-btn" disabled>
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Traitement en cours‚Ä¶
      </button>
      <a href="{% url 'cotisationtontine:group_detail' member.group.id %}" class="btn btn-secondary ms-2">Annuler</a>
    </div>
  </form>
</div>

<script>
(function () {
  'use strict';

  const form = document.getElementById('versement-form');
  const montantInput = document.getElementById('montant');
  const fraisCard = document.getElementById('frais-card');
  const fraisEl = document.getElementById('frais');
  const totalEl = document.getElementById('total');
  const submitBtn = document.getElementById('submit-btn');
  const loadingBtn = document.getElementById('loading-btn');

  // Formatage simple des nombres (s√©parateurs de milliers)
  const fmt = new Intl.NumberFormat('fr-FR');

  function arrondiFCFA(val) {
    if (isNaN(val)) return 0;
    return Math.round(Number(val));
  }

  function updateFrais() {
    let montant = parseFloat(montantInput.value);
    if (isNaN(montant) || montant <= 0) {
      fraisCard.style.display = 'none';
      return;
    }

    // Frais PayDunya: 2,5% + 75 FCFA (align√© avec la vue)
    const fraisPourcent = montant * 0.025;
    const fraisFixe = 75;
    const fraisTotal = arrondiFCFA(fraisPourcent + fraisFixe);
    const total = arrondiFCFA(montant + fraisTotal);

    fraisEl.textContent = fmt.format(fraisTotal);
    totalEl.textContent = fmt.format(total);
    fraisCard.style.display = 'block';
  }

  // Emp√™cher le double-submit + √©tat chargement
  form.addEventListener('submit', (event) => {
    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    } else {
      // Verrouille l‚ÄôUI si valide
      submitBtn.disabled = true;
      loadingBtn.classList.remove('d-none');
    }
    form.classList.add('was-validated');
  });

  // Arrondir automatiquement √† la sortie du champ
  montantInput.addEventListener('blur', () => {
    const v = parseFloat(montantInput.value);
    if (!isNaN(v) && v > 0) {
      montantInput.value = arrondiFCFA(v);
    }
  });

  // Interactions
  montantInput.addEventListener('input', updateFrais);

  // Init
  updateFrais();
})();
</script>
{% endblock %}
