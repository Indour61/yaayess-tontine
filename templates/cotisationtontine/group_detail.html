{% extends 'base.html' %}
{% load humanize %}

{% block title %}DÃ©tails du groupe{% endblock %}

{% block content %}
<div class="container mt-4">

    {% if user_is_admin %}
    <div class="alert alert-success mb-4">
        ğŸ”— Lien d'invitation Ã  partager :
        <input type="text" readonly value="{{ invite_url }}" class="form-control mb-2">

        <a href="https://wa.me/?text=Rejoins notre groupe YaayESS ici ğŸ‘‰ {{ invite_url }}"
           target="_blank"
           class="btn btn-outline-success btn-sm">
            ğŸ“¤ Partager sur WhatsApp
        </a>
    </div>
    {% endif %}

    <h1 class="fw-bold text-success">{{ group.nom }}</h1>

    <p class="mb-1">
        ğŸ“… Date de crÃ©ation : {{ group.date_creation|date:"d/m/Y" }}
    </p>

    {% if group.date_reset %}
      <p class="mb-3 text-muted">
        ğŸ” Dernier reset : {{ group.date_reset|date:"d/m/Y H:i" }}
      </p>
    {% endif %}

    <p class="mb-4">
      ğŸ’° Montant de base :
      <strong class="text-primary">
        {{ group.montant_base|default:"0"|floatformat:0|intcomma }} FCFA
      </strong>
    </p>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} mt-2">
          {{ message|safe }}
        </div>
      {% endfor %}
    {% endif %}

    {% if user_is_admin %}
      <div class="d-flex flex-wrap gap-2 mb-4">

        <!-- âš ï¸ VÃ©rifie que ton urls.py contient name="tirage_au_sort" -->
        <a href="{% url 'cotisationtontine:tirage_au_sort' group.id %}"
           class="btn btn-outline-primary">
          ğŸ² Lancer le tirage au sort
        </a>

        <a href="{% url 'cotisationtontine:tirage_resultat' group.id %}"
           class="btn btn-outline-success">
          ğŸ“Š Voir les rÃ©sultats
        </a>

        <form action="{% url 'cotisationtontine:reset_cycle' group.id %}"
              method="post"
              onsubmit="return confirm('Confirmer la rÃ©initialisation du cycle ?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger">
            â™»ï¸ RÃ©initialiser le cycle
          </button>
        </form>

        <a href="{{ invite_url }}" class="btn btn-primary">
          â• Ajouter un membre
        </a>

      </div>
    {% endif %}

    <h2 class="mt-4">
        {{ membres|length }} membre{{ membres|length|pluralize }}
    </h2>

    <div class="table-responsive shadow-sm rounded mt-3">
      <table class="table table-bordered align-middle mb-0">

        <thead class="table-light">
          <tr>
            <th>Nom</th>
            <th>Actions</th>
            <th>Montant versÃ©</th>
            <th>Dernier versement</th>
            <th>TÃ©lÃ©phone</th>
          </tr>
        </thead>

        <tbody>
          {% for m in membres %}
            <tr>

              <td>
                {% if m.user.nom %}
                  {{ m.user.nom|title }}
                {% else %}
                  {{ m.user.phone }}
                {% endif %}

                {% if m.user == group.admin %}
                  <span class="badge bg-success ms-2">Admin</span>
                {% endif %}
              </td>

              <td>
                {% if m.total_montant|default_if_none:0 < group.montant_base %}
                  <a href="{% url 'cotisationtontine:initier_versement' m.id %}"
                     class="btn btn-sm btn-success">
                     ğŸ’³ Verser
                  </a>
                {% else %}
                  <span class="badge bg-secondary">âœ… Atteint</span>
                {% endif %}
              </td>

              <td>
                <div class="d-flex justify-content-between">
                  <span>
                    {{ m.total_montant|default_if_none:0|floatformat:0|intcomma }} FCFA
                  </span>
                  <small class="text-muted">
                    / {{ group.montant_base|default:"0"|floatformat:0|intcomma }} FCFA
                  </small>
                </div>

                {% if group.montant_base > 0 %}
                <div class="progress mt-1" style="height:6px;">
                  <div class="progress-bar"
                       role="progressbar"
                       style="width:
                       {% widthratio m.total_montant|default_if_none:0 group.montant_base 100 %}%">
                  </div>
                </div>
                {% endif %}
              </td>

              <td>
                {% if m.last_date %}
                  {{ m.last_date|date:"d/m/Y H:i" }} :
                  {{ m.last_amount|default_if_none:0|floatformat:0|intcomma }} FCFA
                {% else %}
                  -
                {% endif %}
              </td>

              <td>{{ m.user.phone }}</td>

            </tr>

          {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                Aucun membre pour l'instant
              </td>
            </tr>
          {% endfor %}
        </tbody>

        <tfoot>
          <tr class="fw-bold table-light">
            <td colspan="2" class="text-end">Total cotisations</td>
            <td>{{ total_montant|floatformat:0|intcomma }} FCFA</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>

      </table>
    </div>

</div>
{% endblock %}


