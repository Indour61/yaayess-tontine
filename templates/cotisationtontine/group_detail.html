{% extends 'base.html' %}
{% load humanize %}

{% block title %}DÃ©tails du groupe{% endblock %}

{% block content %}
<div class="container mt-4">

    {% if user_is_admin %}
    <!-- Lien d'invitation -->
    <div class="alert alert-success mb-4">
        ğŸ”— Lien d'invitation Ã  partager :

        <input type="text" readonly
               value="{{ request.scheme }}://{{ request.get_host }}{% url 'accounts:inscription_et_rejoindre' code=group.code_invitation %}"
               class="form-control mb-2">

        <a href="https://wa.me/?text=Rejoins notre groupe YaayESS ici ğŸ‘‰ {{ request.scheme }}://{{ request.get_host }}{% url 'accounts:inscription_et_rejoindre' code=group.code_invitation %}"
           target="_blank" class="btn btn-outline-success btn-sm">
            ğŸ“¤ Partager sur WhatsApp
        </a>
    </div>
    {% endif %}

    <!-- Infos du groupe -->
    <h1 class="fw-bold text-success">{{ group.nom }}</h1>
    <p class="mb-1">ğŸ“… Date de crÃ©ation : {{ group.date_creation|date:"d/m/Y" }}</p>
    {% if group.date_reset %}
        <p class="mb-3 text-muted">ğŸ” Dernier reset : {{ group.date_reset|date:"d/m/Y H:i" }}</p>
    {% endif %}
    <p class="mb-4">ğŸ’° Montant de base du groupe :
        <strong class="text-primary">{{ group.montant_base|default:"0"|floatformat:0 }} FCFA</strong>
    </p>

    <!-- Messages flash -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} mt-2" role="alert">
                {{ message|safe }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Boutons administratifs -->
    {% if user_is_admin %}
    <div class="d-flex flex-wrap gap-2 mb-3">
        <a href="{% url 'cotisationtontine:tirage_au_sort' group.id %}" class="btn btn-outline-primary">
            ğŸ² Lancer le tirage au sort
        </a>
        <form action="{% url 'cotisationtontine:reset_cycle' group.id %}" method="post" onsubmit="return confirm('Confirmer la rÃ©initialisation du cycle ?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">
                â™»ï¸ RÃ©initialiser le cycle
            </button>
        </form>
        <a href="{% url 'accounts:inscription_et_rejoindre' code=group.code_invitation %}" class="btn btn-primary">
            â• Ajouter un membre
        </a>
    </div>
    {% endif %}

    <!-- Membres -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <h2 class="mt-4">{{ membres.count }} membre{{ membres.count|pluralize }}</h2>
    </div>

    <!-- Tableau des membres -->
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-bordered align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Nom</th>
                    <th style="min-width: 180px;">Actions</th>
                    <th>Montant</th>
                    <th>TÃ©lÃ©phone</th>
                </tr>
            </thead>
            <tbody>
                {% for m in membres %}
                <tr>
                    <td>
                        {{ m.user.nom }}
                        {% if m.user == group.admin %}
                        <span class="badge bg-success ms-2">Admin</span>
                        {% endif %}
                    </td>
                    <td class="d-flex flex-wrap gap-1">
                        {% if m.montant < group.montant_base %}
                        <a href="{% url 'cotisationtontine:initier_versement' m.id %}" class="btn btn-sm btn-success flex-fill">ğŸ’³ Verser</a>
                        {% else %}
                        <button class="btn btn-sm btn-secondary flex-fill" disabled>âœ… Atteint</button>
                        {% endif %}

                        {% if user_is_admin %}
                        <a href="{% url 'cotisationtontine:editer_membre' group.id m.id %}" class="btn btn-sm btn-warning flex-fill">âœï¸</a>
                        <a href="{% url 'cotisationtontine:supprimer_membre' group.id m.id %}" class="btn btn-sm btn-danger flex-fill" onclick="return confirm('Confirmer la suppression ?');">ğŸ—‘ï¸</a>
                        {% endif %}
                    </td>
                    <td>{{ m.montant|intcomma }} FCFA</td>
                    <td>{{ m.user.phone }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center text-muted">Aucun membre pour l'instant</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="fw-bold table-light">
                    <td colspan="2" class="text-end">Total cotisations</td>
                    <td>{{ total_montant|intcomma }} FCFA</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>
{% endblock %}
