{% extends 'base.html' %}
{% load humanize %}

{% block title %}DÃ©tails du groupe{% endblock %}

{% block content %}
<div class="container mt-4">

    {% if user_is_admin %}
    <div class="alert alert-success mb-4">
        ğŸ”— Lien d'invitation Ã  partager :
        <input type="text" readonly value="{{ invite_url }}" class="form-control mb-2">
        <a href="https://wa.me/?text=Rejoins notre groupe YaayESS ici ğŸ‘‰ {{ invite_url }}"
           target="_blank" class="btn btn-outline-success btn-sm">
            ğŸ“¤ Partager sur WhatsApp
        </a>
    </div>
    {% endif %}

    <h1 class="fw-bold text-success">{{ group.nom }}</h1>
    <p class="mb-1">ğŸ“… Date de crÃ©ation : {{ group.date_creation|date:"d/m/Y" }}</p>
    {% if group.date_reset %}
      <p class="mb-3 text-muted">ğŸ” Dernier reset : {{ group.date_reset|date:"d/m/Y H:i" }}</p>
    {% endif %}
    <p class="mb-4">
      ğŸ’° Montant de base du groupe :
      <strong class="text-primary">{{ group.montant_base|default:"0"|floatformat:0|intcomma }} FCFA</strong>
    </p>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} mt-2" role="alert">
          {{ message|safe }}
        </div>
      {% endfor %}
    {% endif %}

    {% if user_is_admin %}
      <div class="d-flex flex-wrap gap-2 mb-3">
        <a href="{% url 'cotisationtontine:tirage_au_sort' group.id %}" class="btn btn-outline-primary">
          ğŸ² Lancer le tirage au sort
        </a>

        <form action="{% url 'cotisationtontine:reset_cycle' group.id %}" method="post"
              onsubmit="return confirm('Confirmer la rÃ©initialisation du cycle ?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger">â™»ï¸ RÃ©initialiser le cycle</button>
        </form>

        <a href="{{ invite_url }}" class="btn btn-primary">â• Ajouter un membre</a>
      </div>
    {% endif %}

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <h2 class="mt-4">{{ membres|length }} membre{{ membres|length|pluralize }}</h2>
    </div>

    <div class="table-responsive shadow-sm rounded">
      <table class="table table-bordered align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Nom</th>
            <th style="min-width: 180px;">Actions</th>
            <th>Montant versÃ©</th>
            <th>Dernier versement</th>
            <th>TÃ©lÃ©phone</th>
          </tr>
        </thead>
        <tbody>
          {% for m in membres %}
            <tr>
              <td>
                {% if m.user.nom %}
                  {{ m.user.nom|title }}
                {% else %}
                  {{ m.user.phone }}
                {% endif %}
                {% if m.user == group.admin %}
                  <span class="badge bg-success ms-2">Admin</span>
                {% endif %}
              </td>

              <td class="d-flex flex-wrap gap-1">
                {% if not m.total_montant or m.total_montant < group.montant_base %}
                  <a href="{% url 'cotisationtontine:initier_versement' m.id %}"
                     class="btn btn-sm btn-success flex-fill">ğŸ’³ Verser</a>
                {% else %}
                  <button class="btn btn-sm btn-secondary flex-fill" disabled>âœ… Atteint</button>
                {% endif %}
              </td>

              {# ---- MONTANT VERSÃ‰ + / MONTANT DE BASE + PROGRESSION ---- #}
              <td>
                <div class="d-flex justify-content-between">
                  <span>{{ m.total_montant|default_if_none:0|floatformat:0|intcomma }} FCFA</span>
                  <small class="text-muted">/ {{ group.montant_base|default:"0"|floatformat:0|intcomma }} FCFA</small>
                </div>
                <div class="progress mt-1" style="height:6px;">
                  <div class="progress-bar" role="progressbar"
                       style="width: {% widthratio m.total_montant|default_if_none:0 group.montant_base|default_if_none:1 100 %}%"
                       aria-valuemin="0" aria-valuemax="100">
                  </div>
                </div>
              </td>

              <td>
                {% if m.last_date %}
                  {{ m.last_date|date:"d/m/Y H:i" }} : {{ m.last_amount|default_if_none:0|floatformat:0|intcomma }} FCFA
                {% else %}
                  -
                {% endif %}
              </td>

              <td>{{ m.user.phone }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">Aucun membre pour l'instant</td>
            </tr>
          {% endfor %}
        </tbody>

        <tfoot>
          <tr class="fw-bold table-light">
            <td colspan="2" class="text-end">Total cotisations</td>
            <td>{{ total_montant|floatformat:0|intcomma }} FCFA</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
</div>
{% endblock %}

