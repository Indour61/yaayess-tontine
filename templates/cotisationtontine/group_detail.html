{% extends 'base.html' %}
{% load humanize %}

{% block title %}DÃ©tails du groupe{% endblock %}

{% block content %}
<div class="container mt-4">

    <!-- =============================== -->
    <!-- ğŸ”” Messages systÃ¨me -->
    <!-- =============================== -->

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}

    <!-- =============================== -->
    <!-- ğŸ”— Lien invitation (Admin) -->
    <!-- =============================== -->

    {% if user_is_admin %}
    <div class="alert alert-success mb-4">
        ğŸ”— Lien d'invitation Ã  partager :
        <input type="text" readonly value="{{ invite_url }}" class="form-control mb-2">

        <a href="https://wa.me/?text=Rejoins notre groupe YaayESS ici ğŸ‘‰ {{ invite_url }}"
           target="_blank"
           class="btn btn-outline-success btn-sm">
            ğŸ“¤ Partager sur WhatsApp
        </a>
    </div>
    {% endif %}

    <!-- =============================== -->
    <!-- ğŸ“Œ Infos Groupe -->
    <!-- =============================== -->

    <h1 class="fw-bold text-success">{{ group.nom }}</h1>

    <p>ğŸ“… CrÃ©Ã© le : {{ group.date_creation|date:"d/m/Y" }}</p>

    {% if group.date_reset %}
      <p class="text-muted">ğŸ” Dernier reset : {{ group.date_reset|date:"d/m/Y H:i" }}</p>
    {% endif %}

    <p class="mb-4">
      ğŸ’° Montant de base :
      <strong class="text-primary">
        {{ group.montant_base|default:"0"|floatformat:0|intcomma }} FCFA
      </strong>
    </p>

    <!-- =============================== -->
    <!-- ğŸš¨ Alertes cycle / validation -->
    <!-- =============================== -->

    {% if versements_en_attente_liste %}
      <div class="alert alert-danger">
        Tous les versements doivent Ãªtre validÃ©s avant le tirage.
      </div>
    {% endif %}

    {% if cycle_termine %}
      <div class="alert alert-warning">
        Tous les membres ont dÃ©jÃ  gagnÃ©. RÃ©initialisez le cycle.
      </div>
    {% endif %}

    <!-- =============================== -->
    <!-- ğŸ² Actions Admin -->
    <!-- =============================== -->

    {% if user_is_admin %}
      <div class="d-flex flex-wrap gap-2 mb-4">

        {% if not versements_en_attente_liste and not cycle_termine %}
          <a href="{% url 'cotisationtontine:tirage_au_sort' group.id %}"
             class="btn btn-outline-primary">
            ğŸ² Lancer le tirage
          </a>
        {% else %}
          <button class="btn btn-outline-secondary" disabled>
            ğŸ² Tirage bloquÃ©
          </button>
        {% endif %}

        <a href="{% url 'cotisationtontine:tirage_resultat' group.id %}"
           class="btn btn-outline-success">
          ğŸ“Š RÃ©sultats
        </a>

        <form action="{% url 'cotisationtontine:reset_cycle' group.id %}"
              method="post"
              onsubmit="return confirm('Confirmer la rÃ©initialisation ?');">
          {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger">
            â™»ï¸ Reset cycle
          </button>
        </form>

        <a href="{{ invite_url }}" class="btn btn-primary">
          â• Ajouter membre
        </a>

      </div>
    {% endif %}

    <!-- =============================== -->
    <!-- ğŸ’³ Versements EN ATTENTE -->
    <!-- =============================== -->

    {% if user_is_admin and versements_en_attente_liste %}
    <div class="card border-warning mb-4">
      <div class="card-header bg-warning fw-bold">
        ğŸ’³ Versements en attente
      </div>
      <div class="table-responsive">
        <table class="table mb-0">
          <thead>
            <tr>
              <th>Membre</th>
              <th>Montant</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for v in versements_en_attente_liste %}
            <tr>
              <td>{{ v.member.user.nom|default:v.member.user.phone }}</td>
              <td>{{ v.montant|floatformat:0|intcomma }} FCFA</td>
              <td>{{ v.date_creation|date:"d/m/Y H:i" }}</td>
              <td class="d-flex gap-2">
                <a href="{% url 'cotisationtontine:valider_versement' v.id %}"
                   class="btn btn-sm btn-success">âœ…</a>
                <a href="{% url 'cotisationtontine:refuser_versement' v.id %}"
                   class="btn btn-sm btn-danger">âŒ</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

    <!-- =============================== -->
    <!-- ğŸ‘¥ Tableau Membres -->
    <!-- =============================== -->

    <h3>{{ membres|length }} membre{{ membres|length|pluralize }}</h3>

    <div class="table-responsive shadow-sm rounded mt-3">
      <table class="table table-bordered align-middle">

        <thead class="table-light">
          <tr>
            <th>Nom</th>
            <th>Action</th>
            <th>Montant versÃ©</th>
            <th>Dernier versement</th>
            <th>TÃ©lÃ©phone</th>
          </tr>
        </thead>

        <tbody>
          {% for m in membres %}
          <tr>

            <td>
              {{ m.user.nom|default:m.user.phone }}
              {% if m.user == group.admin %}
                <span class="badge bg-success">Admin</span>
              {% endif %}
            </td>

            <td>
              {% if m.total_montant < group.montant_base %}
                <a href="{% url 'cotisationtontine:initier_versement' m.id %}"
                   class="btn btn-sm btn-success">
                  ğŸ’³ Verser
                </a>
              {% else %}
                <span class="badge bg-secondary">Atteint</span>
              {% endif %}
            </td>

            <td>
              {{ m.total_montant|floatformat:0|intcomma }} FCFA
            </td>

            <td>
              {% if m.last_date %}
                {{ m.last_date|date:"d/m/Y H:i" }}
              {% else %}
                -
              {% endif %}
            </td>

            <td>{{ m.user.phone }}</td>

          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted">
              Aucun membre
            </td>
          </tr>
          {% endfor %}
        </tbody>

        <tfoot>
          <tr class="fw-bold table-light">
            <td colspan="2" class="text-end">Total</td>
            <td>{{ total_montant|floatformat:0|intcomma }} FCFA</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>

      </table>
    </div>

</div>
{% endblock %}

