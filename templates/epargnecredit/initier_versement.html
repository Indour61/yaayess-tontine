{% extends "base.html" %}
{% block title %}Effectuer un versement{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">
    Effectuer un versement pour
    <strong>{{ member.user.nom|default:member.user.phone }}</strong>
    {% if member.group %}<small class="text-muted">â€” {{ member.group.nom }}</small>{% endif %}
  </h2>

  <form method="post" id="versement-form" class="needs-validation" novalidate autocomplete="off">
    {% csrf_token %}

    <!-- MÃ©thode forcÃ©e Ã  PayDunya -->
    <input type="hidden" name="methode" value="paydunya" />

    <!-- Montant -->
    <div class="mb-3">
      <label for="montant" class="form-label">Montant Ã  verser (FCFA)</label>
      <input
        type="number"
        class="form-control"
        name="montant"
        id="montant"
        min="1"
        step="1"
        inputmode="numeric"
        required
        placeholder="Ex : 5000"
      >
      <div class="form-text">Saisissez un montant positif. Les dÃ©cimales seront arrondies automatiquement.</div>
      <div class="invalid-feedback">Veuillez saisir un montant valide supÃ©rieur Ã  0.</div>
    </div>

    <!-- Infos frais -->
    <div class="card mb-3" id="frais-section" style="display:none;">
      <div class="card-body d-flex flex-wrap align-items-center justify-content-between">
        <div class="me-3">
          <div class="mb-1">ðŸ§¾ <strong>Frais estimÃ©s</strong> (2,5% + 75 FCFA) : <span id="frais" class="fw-semibold">0</span> FCFA</div>
          <div>ðŸ’³ <strong>Total Ã  payer</strong> : <span id="total" class="fw-semibold">0</span> FCFA</div>
        </div>
        <div class="text-muted small">* Calcul indicatif avant redirection.</div>
      </div>
    </div>

    <!-- Boutons -->
    <button type="submit" class="btn btn-success" id="submit-btn">ðŸ’³ Payer avec PayDunya</button>
    <a href="{% url 'epargnecredit:group_detail' member.group.id %}" class="btn btn-secondary ms-2">Annuler</a>
  </form>
</div>

<script>
// Bootstrap validation + anti double-soumission
(() => {
  'use strict';
  const form = document.getElementById('versement-form');
  const submitBtn = document.getElementById('submit-btn');

  form.addEventListener('submit', event => {
    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    } else {
      submitBtn.disabled = true;
      submitBtn.innerText = 'Traitement en cours...';
    }
    form.classList.add('was-validated');
  }, false);
})();

document.addEventListener('DOMContentLoaded', function() {
  const montantInput = document.getElementById('montant');
  const fraisEl = document.getElementById('frais');
  const totalEl = document.getElementById('total');
  const fraisSection = document.getElementById('frais-section');

  const fmt = new Intl.NumberFormat('fr-FR');

  function arrondiFCFA(x) {
    const n = Number(x);
    return Number.isFinite(n) ? Math.round(n) : 0;
  }

  function updateFrais() {
    const v = parseFloat(montantInput.value);
    const montant = (!isNaN(v) && v > 0) ? v : 0;

    if (montant > 0) {
      // 2,5% + 75 FCFA
      const fraisPourcent = montant * 0.025;
      const fraisFixe = 75;
      const fraisTotal = arrondiFCFA(fraisPourcent + fraisFixe);
      const total = arrondiFCFA(montant + fraisTotal);

      fraisEl.textContent = fmt.format(fraisTotal);
      totalEl.textContent = fmt.format(total);
      fraisSection.style.display = 'block';
    } else {
      fraisSection.style.display = 'none';
    }
  }

  montantInput.addEventListener('input', updateFrais);
  montantInput.addEventListener('blur', () => {
    const v = parseFloat(montantInput.value);
    if (!isNaN(v) && v > 0) montantInput.value = arrondiFCFA(v);
  });

  updateFrais();
});
</script>
{% endblock %}
